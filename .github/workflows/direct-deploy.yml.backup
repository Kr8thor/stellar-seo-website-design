name: ğŸš€ Direct Deploy to Hosting

on:
  # Trigger on push to main branch
  push:
    branches: [ main ]
    paths: 
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'vite.config.ts'
      - 'tailwind.config.ts'
      - '**.md'
      - '**.txt'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force complete rebuild and deploy'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'
  PRODUCTION_URL: 'https://mardenseo.com'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper builds
    
    - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ”§ Install dependencies
      run: |
        echo "Installing dependencies..."
        npm ci --prefer-offline --no-audit
        echo "âœ… Dependencies installed successfully"
    
    - name: ğŸ—ï¸ Build production bundle
      run: |
        echo "ğŸ”¨ Building production bundle..."
        NODE_ENV=production npm run build
        echo "âœ… Build completed!"
        
        # Verify critical files exist
        echo "ğŸ” Verifying build output..."
        test -f dist/index.html && echo "âœ… index.html generated" || (echo "âŒ index.html missing" && exit 1)
        test -d dist/assets && echo "âœ… assets folder generated" || (echo "âŒ assets folder missing" && exit 1)
        test -f dist/sitemap.xml && echo "âœ… sitemap.xml found" || echo "âš ï¸ sitemap.xml missing"
        test -f dist/robots.txt && echo "âœ… robots.txt found" || echo "âš ï¸ robots.txt missing"
        
        # Show bundle info
        echo "ğŸ“Š Bundle Information:"
        ls -la dist/assets/ || echo "No assets found"
        
        # Verify sitemap is clean (no script tags)
        if grep -q "<script" dist/sitemap.xml 2>/dev/null; then
          echo "âŒ ERROR: sitemap.xml contains script tags!"
          head -20 dist/sitemap.xml
          exit 1
        else
          echo "âœ… sitemap.xml is clean (no script injection)"
        fi
        
    - name: ğŸ“‚ Prepare files for deployment
      run: |
        echo "ğŸ—‚ï¸ Preparing deployment files..."
        
        # Set proper permissions
        find dist -type f -exec chmod 644 {} \;
        find dist -type d -exec chmod 755 {} \;
        
        # Create deployment info file
        cat > dist/deployment-info.txt << EOF
        ğŸš€ DEPLOYMENT INFO
        ==================
        Deploy Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        Git Commit: ${GITHUB_SHA:0:8}
        Branch: ${GITHUB_REF_NAME}
        Triggered By: ${GITHUB_EVENT_NAME}
        Workflow: ${GITHUB_WORKFLOW}
        Actor: ${GITHUB_ACTOR}
        
        ğŸ¯ SEO Features:
        âœ… Dynamic meta tags
        âœ… Schema.org structured data  
        âœ… Clean XML sitemap
        âœ… Open Graph optimization
        âœ… Performance optimized
        EOF
        
        echo "âœ… Files prepared for deployment"
    
    - name: ğŸŒ Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/
        server-dir: ./public_html/
        exclude: |
          **/.git*
          **/.DS_Store
          **/Thumbs.db
          **/*.tmp
          **/node_modules/**
        state-name: .ftp-deploy-sync-state.json
        dry-run: false
        log-level: standard
    
    - name: ğŸ” Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        
        # Wait a moment for files to propagate
        sleep 30
        
        # Test critical URLs
        echo "Testing main site..."
        curl -I "${{ env.PRODUCTION_URL }}" || echo "âš ï¸ Main site check failed"
        
        echo "Testing JavaScript bundle..."
        curl -I "${{ env.PRODUCTION_URL }}/assets/" || echo "âš ï¸ Assets check failed"
        
        echo "Testing sitemap..."
        curl -I "${{ env.PRODUCTION_URL }}/sitemap.xml" || echo "âš ï¸ Sitemap check failed"
        
        echo "âœ… Deployment verification completed"
    
    - name: ğŸ“‹ Post-deployment validation
      run: |
        echo "ğŸ¯ POST-DEPLOYMENT VALIDATION"
        echo "=============================="
        
        # Test sitemap specifically for script injection
        echo "ğŸ” Testing sitemap for script injection..."
        SITEMAP_RESPONSE=$(curl -s "${{ env.PRODUCTION_URL }}/sitemap.xml" | head -10)
        
        if echo "$SITEMAP_RESPONSE" | grep -q "<script"; then
          echo "âŒ CRITICAL: Sitemap still contains script tags!"
          echo "$SITEMAP_RESPONSE"
          echo "Manual intervention required!"
        else
          echo "âœ… Sitemap is clean - no script injection detected"
        fi
        
        echo ""
        echo "ğŸŒ Test URLs:"
        echo "Main Site: ${{ env.PRODUCTION_URL }}"
        echo "Sitemap: ${{ env.PRODUCTION_URL }}/sitemap.xml"
        echo "Robots: ${{ env.PRODUCTION_URL }}/robots.txt"
        echo ""
        echo "ğŸ‰ Deployment completed successfully!"
    
    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "================================================"
        echo "ğŸ‰ MARDEN SEO DEPLOYMENT SUMMARY"
        echo "================================================"
        echo "ğŸ“¦ Project: Marden SEO Professional Website"
        echo "ğŸŒ Domain: ${{ env.PRODUCTION_URL }}"
        echo "ğŸ“… Deploy Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ”¨ Triggered By: ${{ github.event_name }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "ğŸ“ Commit: ${GITHUB_SHA:0:8}"
        echo ""
        echo "ğŸ” SEO Enhancements Deployed:"
        echo "âœ… Unique meta tags for all pages"
        echo "âœ… Schema.org business markup"
        echo "âœ… Clean XML sitemap (no script injection)"
        echo "âœ… Open Graph social optimization"
        echo "âœ… Twitter Card integration"
        echo "âœ… Performance-optimized bundles"
        echo ""
        echo "ğŸš€ Next Steps:"
        echo "1. Visit ${{ env.PRODUCTION_URL }} to verify site"
        echo "2. Test key URLs for functionality"
        echo "3. Submit updated sitemap to Google Search Console"
        echo "4. Monitor SEO performance improvements"
        echo "================================================"