name: Build and Deploy to Production

on:
  # Trigger on push to main branch
  push:
    branches: [ main ]
    paths: 
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'vite.config.ts'
      - 'tailwind.config.ts'
      - 'MANUAL-DEPLOY-TRIGGER.txt'
      - 'dist/**'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force complete rebuild'
        required: false
        default: 'false'
        type: boolean

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Allow pushing to repository
      
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ”§ Install dependencies
      run: npm ci
    
    - name: ğŸ—ï¸ Build project
      run: npm run build
      env:
        # Ensure production build
        NODE_ENV: production
        
    - name: ğŸ“ Verify build output
      run: |
        echo "Build completed. Checking dist folder..."
        ls -la dist/
        echo "Checking for main files..."
        test -f dist/index.html && echo "âœ… index.html found" || echo "âŒ index.html missing"
        test -d dist/assets && echo "âœ… assets folder found" || echo "âŒ assets folder missing"
        
    - name: ğŸ—‚ï¸ Prepare dist folder for deployment
      run: |
        # Ensure proper file permissions for cPanel
        find dist -type f -exec chmod 644 {} \;
        find dist -type d -exec chmod 755 {} \;
        
        # Verify critical files exist
        test -f dist/.htaccess || echo "âš ï¸ .htaccess not found"
        test -f dist/robots.txt || echo "âš ï¸ robots.txt not found"
        test -f dist/site.webmanifest || echo "âš ï¸ site.webmanifest not found"
    
    - name: ğŸ“ Commit updated dist files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Build Bot"
        
        # Add all changes in dist folder
        git add dist/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes in dist folder to commit"
          echo "CHANGES_MADE=false" >> $GITHUB_ENV
        else
          echo "Changes detected in dist folder"
          
          # Create detailed commit message with build info
          COMMIT_MSG="ğŸš€ Auto-build: Update dist files with latest SEO enhancements
          
          ğŸ“Š Build Summary:
          - Built from commit: ${GITHUB_SHA:0:8}
          - Triggered by: ${{ github.event_name }}
          - Build time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - SEO enhancements included âœ…
          - React Helmet dynamic meta tags âœ…
          - Schema.org structured data âœ…
          - Enhanced Open Graph optimization âœ…
          
          ğŸ¯ This build includes all Phase 1 & 2 SEO improvements
          Ready for cPanel deployment to mardenseo.com"
          
          git commit -m "$COMMIT_MSG"
          echo "CHANGES_MADE=true" >> $GITHUB_ENV
        fi
    
    - name: ğŸš€ Push updated dist files
      if: env.CHANGES_MADE == 'true'
      run: |
        echo "Pushing updated build to repository..."
        git push
        echo "âœ… Build deployed successfully!"
        echo "The updated files will be automatically deployed by cPanel"
    
    - name: âœ… Deployment Summary
      run: |
        echo "================================================"
        echo "ğŸ‰ BUILD AND DEPLOYMENT COMPLETED"
        echo "================================================"
        echo "ğŸ“¦ Project: Marden SEO Website"
        echo "ğŸŒ Domain: https://mardenseo.com"
        echo "ğŸ“… Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ”¨ Build Trigger: ${{ github.event_name }}"
        echo "ğŸ“‹ Changes Made: ${{ env.CHANGES_MADE || 'false' }}"
        echo ""
        echo "ğŸ” SEO Features Included:"
        echo "âœ… Dynamic meta tags via React Helmet"
        echo "âœ… Unique SEO data for all 11 pages"
        echo "âœ… Schema.org structured data"
        echo "âœ… Enhanced Open Graph optimization"
        echo "âœ… Twitter Card optimization"
        echo "âœ… Service-specific schemas"
        echo "âœ… Breadcrumb navigation schema"
        echo "âœ… FAQ and HowTo schemas"
        echo ""
        echo "ğŸš€ Next Steps:"
        echo "- cPanel will automatically deploy from dist/ folder"
        echo "- Changes should be live within 1-5 minutes"
        echo "- Verify at https://mardenseo.com"
        echo "- Check SEO with browser dev tools"
        echo "================================================"
