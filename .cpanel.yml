---
deployment:
  tasks:
    # Set up variables and logging
    - export DEPLOYPATH=/home/marddium/public_html
    - export REPOPATH=/home/marddium/repositories/stellar-seo-website-design
    - export LOGFILE=/home/marddium/deployment-debug.log
    - echo "=== DEPLOYMENT DEBUG LOG $(date) ===" > $LOGFILE
    
    # Test basic commands and paths
    - echo "ğŸ” DIAGNOSTIC: Testing basic system commands" | tee -a $LOGFILE
    - whoami | tee -a $LOGFILE
    - pwd | tee -a $LOGFILE
    - echo "ğŸ” DIAGNOSTIC: Checking if paths exist" | tee -a $LOGFILE
    - test -d $REPOPATH && echo "âœ… Repository path exists: $REPOPATH" | tee -a $LOGFILE || echo "âŒ Repository path missing: $REPOPATH" | tee -a $LOGFILE
    - test -d $DEPLOYPATH && echo "âœ… Deploy path exists: $DEPLOYPATH" | tee -a $LOGFILE || echo "âŒ Deploy path missing: $DEPLOYPATH" | tee -a $LOGFILE
    
    # Repository operations
    - echo "ğŸ”§ REPOSITORY: Working from repository directory" | tee -a $LOGFILE
    - cd $REPOPATH || (echo "âŒ FATAL: Cannot access repository path" | tee -a $LOGFILE && exit 1)
    - pwd | tee -a $LOGFILE
    - echo "ğŸ“Š Git status before cleanup:" | tee -a $LOGFILE
    - git status 2>&1 | tee -a $LOGFILE
    - echo "ğŸ§¹ Stashing any local changes..." | tee -a $LOGFILE
    - git stash push -u -m "Auto-stash before deployment $(date)" 2>&1 | tee -a $LOGFILE || echo "âš ï¸ Stash failed (may be normal)" | tee -a $LOGFILE
    - echo "ğŸ”„ Ensuring we're on main branch..." | tee -a $LOGFILE
    - git checkout main 2>&1 | tee -a $LOGFILE
    - echo "â¬‡ï¸ Fetching latest from GitHub..." | tee -a $LOGFILE
    - git fetch origin main 2>&1 | tee -a $LOGFILE
    - echo "ğŸ”¨ Hard reset to match GitHub exactly..." | tee -a $LOGFILE
    - git reset --hard origin/main 2>&1 | tee -a $LOGFILE
    - echo "ğŸ§½ Cleaning any remaining untracked files..." | tee -a $LOGFILE
    - git clean -fd 2>&1 | tee -a $LOGFILE
    
    # Verify repository state
    - echo "âœ… Repository sync completed!" | tee -a $LOGFILE
    - echo "ğŸ“‹ Current commit after reset:" | tee -a $LOGFILE
    - git log --oneline -1 2>&1 | tee -a $LOGFILE
    
    # BUILD PROCESS - This is the key addition!
    - echo "ğŸ—ï¸ BUILD: Installing dependencies..." | tee -a $LOGFILE
    - npm install 2>&1 | tee -a $LOGFILE || echo "âŒ npm install failed" | tee -a $LOGFILE
    - echo "ğŸ—ï¸ BUILD: Building production files..." | tee -a $LOGFILE
    - npm run build 2>&1 | tee -a $LOGFILE || echo "âŒ npm build failed" | tee -a $LOGFILE
    
    # Check dist folder contents after build
    - echo "ğŸ“ Checking dist folder contents after build:" | tee -a $LOGFILE
    - ls -la $REPOPATH/dist/ 2>&1 | tee -a $LOGFILE || echo "âŒ Cannot list dist folder after build" | tee -a $LOGFILE
    - echo "ğŸ“Š Dist folder file count:" | tee -a $LOGFILE
    - find $REPOPATH/dist/ -type f | wc -l 2>&1 | tee -a $LOGFILE || echo "âŒ Cannot count dist files" | tee -a $LOGFILE
    
    # Check current web directory
    - echo "ğŸ—‚ï¸ Checking current web directory contents:" | tee -a $LOGFILE
    - ls -la $DEPLOYPATH/ 2>&1 | tee -a $LOGFILE || echo "âŒ Cannot list deploy path" | tee -a $LOGFILE
    
    # Test copy operation
    - echo "ğŸš€ DEPLOYMENT: Starting file copy..." | tee -a $LOGFILE
    - echo "Source: $REPOPATH/dist/*" | tee -a $LOGFILE
    - echo "Target: $DEPLOYPATH/" | tee -a $LOGFILE
    
    # Perform the copy with detailed logging
    - /bin/cp -R $REPOPATH/dist/* $DEPLOYPATH/ 2>&1 | tee -a $LOGFILE || echo "âŒ Copy operation failed" | tee -a $LOGFILE
    
    # Set permissions
    - echo "ğŸ” Setting proper permissions..." | tee -a $LOGFILE
    - /bin/find $DEPLOYPATH -type d -exec chmod 755 {} \; 2>&1 | tee -a $LOGFILE || echo "âš ï¸ Directory permission setting failed" | tee -a $LOGFILE
    - /bin/find $DEPLOYPATH -type f -exec chmod 644 {} \; 2>&1 | tee -a $LOGFILE || echo "âš ï¸ File permission setting failed" | tee -a $LOGFILE
    
    # Verify deployment results
    - echo "âœ… VERIFICATION: Checking deployed files..." | tee -a $LOGFILE
    - test -f $DEPLOYPATH/index.html && echo "âœ… index.html deployed successfully" | tee -a $LOGFILE || echo "âŒ index.html missing!" | tee -a $LOGFILE
    - test -f $DEPLOYPATH/sitemap.xml && echo "âœ… sitemap.xml deployed successfully" | tee -a $LOGFILE || echo "âŒ sitemap.xml missing!" | tee -a $LOGFILE
    - test -f $DEPLOYPATH/robots.txt && echo "âœ… robots.txt deployed successfully" | tee -a $LOGFILE || echo "âŒ robots.txt missing!" | tee -a $LOGFILE
    
    # Final verification
    - echo "ğŸ“Š Final web directory listing:" | tee -a $LOGFILE
    - ls -la $DEPLOYPATH/ 2>&1 | tee -a $LOGFILE
    - echo "ğŸ‰ Deployment script completed!" | tee -a $LOGFILE
    - echo "ğŸŒ Website should be live at https://mardenseo.com" | tee -a $LOGFILE
    - echo "ğŸ“‹ Check deployment log: /home/marddium/deployment-debug.log" | tee -a $LOGFILE
    - echo "ğŸ• Deployment time: $(date)" | tee -a $LOGFILE